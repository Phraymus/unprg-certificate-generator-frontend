<mat-card class="cardWithShadow theme-card">
  <mat-card-header class="header-fixed">
    <mat-card-title class="m-b-0">
          <span
            class="iconify me-2"
            [attr.data-icon]="'solar:user-plus-outline'"
            data-inline="false"
            style="font-size: 28px;">
          </span>
      Participantes
      <span style="font-size: 0.875em !important;" class="pt-2 ps-1">{{ data.action }}</span>
      <div class="evento-info">
        <small>Evento: {{ data.evento.nombre }} ({{ data.evento.codigo }})</small>
      </div>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content class="b-t-1">
    <form [formGroup]="participanteForm" (ngSubmit)="onSubmit()" class="participante-form">

      <!-- Sección: Selección/Datos de Persona -->
      <div class="section-header">
        <h3 class="section-title">
          <mat-icon>person_search</mat-icon>
          {{ isEditMode ? 'Datos del Participante' : 'Buscar/Registrar Persona' }}
        </h3>
      </div>

      <div class="row" *ngIf="!isEditMode && !isReadOnlyMode">
        <div class="col-md-12">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Buscar persona por DNI o nombre</mat-label>
            <input matInput formControlName="personaBusqueda"
                   placeholder="Escriba DNI o nombre para buscar..."
                   [matAutocomplete]="autoPersona">
            <mat-autocomplete #autoPersona="matAutocomplete"
                              [displayWith]="displayPersona"
                              (optionSelected)="onPersonaSelected($event)">
              <mat-option *ngFor="let persona of personasFiltradas | async" [value]="persona">
                <span>{{ persona.dni }} - {{ persona.nombres }} {{ persona.apellidoPaterno }} {{ persona.apellidoMaterno }}</span>
                <small class="text-muted d-block">{{ persona.email }}</small>
              </mat-option>
              <mat-option *ngIf="!(personasFiltradas | async)?.length && f['personaBusqueda'].value"
                          [value]="null" disabled>
                <em>No se encontraron personas. Complete los datos abajo para registrar una nueva.</em>
              </mat-option>
            </mat-autocomplete>
            <mat-hint>Busque una persona existente o complete los datos para crear una nueva</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección: Datos Personales -->
      <div class="section-header mt-4">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Datos Personales
        </h3>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>DNI</mat-label>
            <input matInput formControlName="dni" placeholder="12345678" maxlength="8"
                   [readonly]="isReadOnlyMode || (isEditMode && personaExistente)">
            <mat-error *ngIf="f['dni'].touched && f['dni'].errors && !isReadOnlyMode">
              {{ getErrorMessage('dni') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Nombres</mat-label>
            <input matInput formControlName="nombres" placeholder="Ingrese nombres"
                   [readonly]="isReadOnlyMode">
            <mat-error *ngIf="f['nombres'].touched && f['nombres'].errors && !isReadOnlyMode">
              {{ getErrorMessage('nombres') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Apellido Paterno</mat-label>
            <input matInput formControlName="apellidoPaterno" placeholder="Ingrese apellido paterno"
                   [readonly]="isReadOnlyMode">
            <mat-error *ngIf="f['apellidoPaterno'].touched && f['apellidoPaterno'].errors && !isReadOnlyMode">
              {{ getErrorMessage('apellidoPaterno') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Apellido Materno</mat-label>
            <input matInput formControlName="apellidoMaterno" placeholder="Ingrese apellido materno"
                   [readonly]="isReadOnlyMode">
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" placeholder="usuario@ejemplo.com"
                   [readonly]="isReadOnlyMode">
            <mat-error *ngIf="f['email'].touched && f['email'].errors && !isReadOnlyMode">
              {{ getErrorMessage('email') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefono" placeholder="987654321" maxlength="9"
                   [readonly]="isReadOnlyMode">
            <mat-error *ngIf="f['telefono'].touched && f['telefono'].errors && !isReadOnlyMode">
              {{ getErrorMessage('telefono') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección: Datos de Participación -->
      <div class="section-header mt-4">
        <h3 class="section-title">
          <mat-icon>event</mat-icon>
          Datos de Participación
        </h3>
      </div>

      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo de participante</mat-label>
            <mat-select formControlName="tipoParticipante" [disabled]="isReadOnlyMode">
              @for ( tipoParticipante of tipoParticipantesDisponibles; track tipoParticipante.id) {
                <mat-option [value]="tipoParticipante.id">{{tipoParticipante.nombre}} ({{tipoParticipante.codigo}})</mat-option>
              }
            </mat-select>
            <mat-error *ngIf="f['tipoParticipante'].touched && f['tipoParticipante'].errors && !isReadOnlyMode">
              {{ getErrorMessage('tipoParticipante') }}
            </mat-error>
          </mat-form-field>
        </div>
        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="estado" [disabled]="isReadOnlyMode">
              <mat-option value="1">Activo</mat-option>
              <mat-option value="2">Inactivo</mat-option>
              <mat-option value="3">Pendiente</mat-option>
              <mat-option value="4">Completado</mat-option>
            </mat-select>
            <mat-error *ngIf="f['estado'].touched && f['estado'].errors && !isReadOnlyMode">
              {{ getErrorMessage('estado') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha de Inscripción</mat-label>
            <input matInput formControlName="fechaInscripcion"
                   [matDatepicker]="picker"
                   placeholder="Seleccione fecha"
                   [readonly]="isReadOnlyMode">
            <mat-datepicker-toggle matIconSuffix [for]="picker" [disabled]="isReadOnlyMode"></mat-datepicker-toggle>
            <mat-datepicker #picker [disabled]="isReadOnlyMode"></mat-datepicker>
            <mat-error *ngIf="f['fechaInscripcion'].touched && f['fechaInscripcion'].errors && !isReadOnlyMode">
              {{ getErrorMessage('fechaInscripcion') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Nota (0-20)</mat-label>
            <input matInput type="number" formControlName="nota"
                   placeholder="0.0" min="0" max="20" step="0.1"
                   [readonly]="isReadOnlyMode">
            <mat-error *ngIf="f['nota'].touched && f['nota'].errors && !isReadOnlyMode">
              {{ getErrorMessage('nota') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección: Comprobante de Pago -->
      <div class="section-header mt-4">
        <h3 class="section-title">
          <mat-icon>receipt</mat-icon>
          Comprobante de Pago
          <span class="optional-badge">Opcional</span>
        </h3>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="upload-container">
            <!-- Vista previa de la imagen -->
            <div class="preview-section" *ngIf="imagePreview || (isEditMode && existingImageBase64)">
              <div class="image-preview-wrapper">
                <img [src]="imagePreview || ('data:image/png;base64,' + existingImageBase64)"
                     alt="Preview de comprobante"
                     class="image-preview">
                <button
                  mat-icon-button
                  type="button"
                  class="remove-image-btn"
                  (click)="removeImage()"
                  *ngIf="!isReadOnlyMode"
                  matTooltip="Eliminar imagen">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>

            <!-- Área de carga -->
            <div class="upload-area" *ngIf="!imagePreview && !existingImageBase64 && !isReadOnlyMode">
              <input
                type="file"
                #fileInput
                (change)="onFileSelected($event)"
                accept="image/png,image/jpeg,image/jpg"
                style="display: none;">

              <div class="upload-content" (click)="fileInput.click()">
                <mat-icon class="upload-icon">cloud_upload</mat-icon>
                <p class="upload-text">Haz clic para cargar el comprobante</p>
                <p class="upload-hint">PNG, JPG o JPEG (máx. 5MB)</p>
              </div>
            </div>

            <!-- Botón para cambiar imagen en modo edición -->
            <div class="change-image-section" *ngIf="(imagePreview || existingImageBase64) && !isReadOnlyMode">
              <input
                type="file"
                #fileInput2
                (change)="onFileSelected($event)"
                accept="image/png,image/jpeg,image/jpg"
                style="display: none;">

              <button
                mat-stroked-button
                type="button"
                (click)="fileInput2.click()"
                class="change-image-btn">
                <mat-icon>edit</mat-icon>
                Cambiar imagen
              </button>
            </div>

            <!-- Mensaje informativo si no hay imagen -->
            <div class="no-image-info" *ngIf="!imagePreview && !existingImageBase64 && isReadOnlyMode">
              <mat-icon>image_not_supported</mat-icon>
              <p>No se ha cargado ningún comprobante</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Información adicional sobre la imagen -->
      <div class="row" *ngIf="selectedFileName">
        <div class="col-md-12">
          <div class="file-info">
            <mat-icon class="info-icon">info</mat-icon>
            <span>Archivo seleccionado: <strong>{{ selectedFileName }}</strong></span>
            <span *ngIf="selectedFileSize"> ({{ selectedFileSize }})</span>
          </div>
        </div>
      </div>

      <!-- Info del evento -->
      <div class="evento-resumen mt-4">
        <mat-card class="evento-card">
          <mat-card-content>
            <h4><mat-icon>event</mat-icon> Información del Evento</h4>
            <div class="evento-details">
              <p><strong>Código:</strong> {{ data.evento.codigo }}</p>
              <p><strong>Nombre:</strong> {{ data.evento.nombre }}</p>
              <p><strong>Fecha Inicio:</strong> {{ data.evento.fechaInicio | date:'dd/MM/yyyy' }}</p>
              <p><strong>Fecha Fin:</strong> {{ data.evento.fechaFin | date:'dd/MM/yyyy' }}</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

    </form>
  </mat-card-content>

  <mat-card-footer class="p-3">
    <div class="d-flex justify-content-end gap-2">
      <button mat-stroked-button type="button" (click)="onCancel()" [disabled]="isLoading">
        <mat-icon>close</mat-icon>
        {{ isReadOnlyMode ? 'Cerrar' : 'Cancelar' }}
      </button>

      <button mat-flat-button color="primary" type="submit"
              (click)="onSubmit()"
              [disabled]="participanteForm.invalid || isLoading || isReadOnlyMode"
              class="ms-2"
              *ngIf="!isReadOnlyMode">
        <mat-icon *ngIf="!isLoading">{{ isEditMode ? 'edit' : 'save' }}</mat-icon>
        <mat-icon *ngIf="isLoading" class="spinning">sync</mat-icon>
        {{ isLoading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Guardar') }}
      </button>
    </div>
  </mat-card-footer>
</mat-card>
