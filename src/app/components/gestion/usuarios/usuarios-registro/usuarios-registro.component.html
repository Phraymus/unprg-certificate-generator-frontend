<mat-card class="cardWithShadow theme-card">
  <mat-card-header>
    <mat-card-title class="m-b-0">
      <span
        class="iconify me-2"
        [attr.data-icon]="'solar:users-group-two-rounded-outline'"
        data-inline="false"
        style="font-size: 28px;">
      </span>
      Usuarios
      <span style="font-size: 0.875em !important;" class="pt-2 ps-1">{{ data.action }}</span>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content class="b-t-1">
    <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="usuario-form">

      <!-- Sección: Datos de Usuario -->
      <div class="section-header">
        <h3 class="section-title">
          <mat-icon>account_circle</mat-icon>
          Datos de Usuario
        </h3>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Usuario</mat-label>
            <input matInput formControlName="usuario" placeholder="Ingrese nombre de usuario">
            <mat-error *ngIf="f['usuario'].touched && f['usuario'].errors">
              {{ getErrorMessage('usuario') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Rol</mat-label>
            <mat-select formControlName="rol">
              <mat-option value="admin">Administrador</mat-option>
              <mat-option value="user">Usuario</mat-option>
              <mat-option value="moderator">Moderador</mat-option>
            </mat-select>
            <mat-error *ngIf="f['rol'].touched && f['rol'].errors">
              {{ getErrorMessage('rol') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row" *ngIf="!isEditMode || (isEditMode && f['password'].value)">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>{{ isEditMode ? 'Nueva Contraseña (opcional)' : 'Contraseña' }}</mat-label>
            <input matInput type="password" formControlName="password"
                   [placeholder]="isEditMode ? 'Dejar vacío para mantener actual' : 'Ingrese contraseña'">
            <mat-error *ngIf="f['password'].touched && f['password'].errors">
              {{ getErrorMessage('password') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6" *ngIf="f['password'].value">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Confirmar Contraseña</mat-label>
            <input matInput type="password" formControlName="confirmPassword"
                   placeholder="Confirme la contraseña">
            <mat-error *ngIf="f['confirmPassword'].touched && f['confirmPassword'].errors">
              {{ getErrorMessage('confirmPassword') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección: Datos Personales -->
      <div class="section-header mt-4">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Datos Personales
        </h3>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Nombres</mat-label>
            <input matInput formControlName="nombres" placeholder="Ingrese nombres">
            <mat-error *ngIf="f['nombres'].touched && f['nombres'].errors">
              {{ getErrorMessage('nombres') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Apellido Paterno</mat-label>
            <input matInput formControlName="apellidoPaterno" placeholder="Ingrese apellido paterno">
            <mat-error *ngIf="f['apellidoPaterno'].touched && f['apellidoPaterno'].errors">
              {{ getErrorMessage('apellidoPaterno') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Apellido Materno</mat-label>
            <input matInput formControlName="apellidoMaterno" placeholder="Ingrese apellido materno">
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>DNI</mat-label>
            <input matInput formControlName="dni" placeholder="12345678" maxlength="8">
            <mat-error *ngIf="f['dni'].touched && f['dni'].errors">
              {{ getErrorMessage('dni') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Sección: Datos de Contacto -->
      <div class="section-header mt-4">
        <h3 class="section-title">
          <mat-icon>contact_mail</mat-icon>
          Datos de Contacto
        </h3>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" placeholder="usuario@ejemplo.com">
            <mat-error *ngIf="f['email'].touched && f['email'].errors">
              {{ getErrorMessage('email') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefono" placeholder="987654321" maxlength="9">
            <mat-error *ngIf="f['telefono'].touched && f['telefono'].errors">
              {{ getErrorMessage('telefono') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha de Nacimiento</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="estado">
              <mat-option [value]="true">Activo</mat-option>
              <mat-option [value]="false">Inactivo</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Dirección</mat-label>
            <textarea matInput formControlName="direccion" placeholder="Ingrese dirección completa"
                      rows="3"></textarea>
          </mat-form-field>
        </div>
      </div>

    </form>
  </mat-card-content>

  <mat-card-footer class="p-3">
    <div class="d-flex justify-content-end gap-2">
      <button mat-stroked-button type="button" (click)="onCancel()" [disabled]="isLoading">
        <mat-icon>close</mat-icon>
        Cancelar
      </button>

      <button mat-flat-button color="primary" type="submit"
              (click)="onSubmit()"
              [disabled]="usuarioForm.invalid || isLoading"
              class="ms-2">
        <mat-icon *ngIf="!isLoading">{{ isEditMode ? 'edit' : 'save' }}</mat-icon>
        <mat-icon *ngIf="isLoading" class="spinning">sync</mat-icon>
        {{ isLoading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Guardar') }}
      </button>
    </div>
  </mat-card-footer>
</mat-card>
